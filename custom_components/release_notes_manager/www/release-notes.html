<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home Assistant Release Notes Manager v0.4.0</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: #f9fafb; color: #111827; }
    
    /* Utility Classes */
    .min-h-screen { min-height: 100vh; }
    .bg-gray-50 { background-color: #f9fafb; }
    .bg-gray-100 { background-color: #f3f4f6; }
    .bg-gray-200 { background-color: #e5e7eb; }
    .bg-white { background-color: #ffffff; }
    .bg-blue-600 { background-color: #2563eb; }
    .bg-green-50 { background-color: #f0fdf4; }
    .bg-green-100 { background-color: #dcfce7; }
    .bg-green-600 { background-color: #16a34a; }
    .bg-red-100 { background-color: #fee2e2; }
    .bg-red-600 { background-color: #dc2626; }
    .bg-yellow-50 { background-color: #fefce8; }
    .bg-yellow-600 { background-color: #ca8a04; }
    .bg-orange-100 { background-color: #ffedd5; }
    .bg-purple-100 { background-color: #f3e8ff; }
    .bg-pink-100 { background-color: #fce7f3; }
    
    .text-white { color: #ffffff; }
    .text-gray-500 { color: #6b7280; }
    .text-gray-600 { color: #4b5563; }
    .text-gray-700 { color: #374151; }
    .text-gray-800 { color: #1f2937; }
    .text-red-600 { color: #dc2626; }
    .text-blue-600 { color: #2563eb; }
    .text-green-600 { color: #16a34a; }
    .text-green-700 { color: #15803d; }
    .text-green-800 { color: #166534; }
    .text-orange-800 { color: #9a3412; }
    .text-purple-800 { color: #6b21a8; }
    .text-pink-800 { color: #9f1239; }
    .text-yellow-600 { color: #ca8a04; }
    
    .border-green-200 { border-color: #bbf7d0; }
    .border-yellow-200 { border-color: #fef08a; }

    .p-3 { padding: 0.75rem; }
    .p-4 { padding: 1rem; }
    .p-6 { padding: 1.5rem; }
    .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
    .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
    .px-4 { padding-left: 1rem; padding-right: 1rem; }
    .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
    .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
    .py-6 { padding-top: 1.5rem; padding-bottom: 1.5rem; }
    .pt-4 { padding-top: 1rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mb-3 { margin-bottom: 0.75rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-6 { margin-bottom: 1.5rem; }
    .mt-3 { margin-top: 0.75rem; }
    .mr-3 { margin-right: 0.75rem; }
    
    .max-w-6xl { max-width: 72rem; margin-left: auto; margin-right: auto; }
    
    .flex { display: flex; }
    .flex-1 { flex: 1; }
    .gap-2 { gap: 0.5rem; }
    .gap-3 { gap: 0.75rem; }
    .items-center { align-items: center; }
    .items-start { align-items: flex-start; }
    .justify-between { justify-content: space-between; }
    
    .rounded { border-radius: 0.25rem; }
    .rounded-lg { border-radius: 0.5rem; }
    .border { border: 1px solid #e5e7eb; }
    .border-t { border-top: 1px solid #e5e7eb; }
    .border-b { border-bottom: 1px solid #e5e7eb; }
    .shadow { box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); }
    
    .text-sm { font-size: 0.875rem; }
    .text-xl { font-size: 1.25rem; }
    .text-2xl { font-size: 1.5rem; }
    .font-bold { font-weight: 700; }
    .font-semibold { font-weight: 600; }
    .font-medium { font-weight: 500; }
    .italic { font-style: italic; }
    
    .w-full { width: 100%; }
    .block { display: block; }
    .hidden { display: none; }
    .cursor-pointer { cursor: pointer; }
    .space-y-2 > * + * { margin-top: 0.5rem; }
    .space-y-3 > * + * { margin-top: 0.75rem; }
    
    button { border: none; cursor: pointer; transition: all 0.15s; font-size: 0.875rem; }
    button:hover.bg-blue-600 { background-color: #1d4ed8; }
    button:hover.bg-green-600 { background-color: #15803d; }
    button:hover.bg-green-100 { background-color: #bbf7d0; }
    button:hover.bg-red-600 { background-color: #b91c1c; }
    button:hover.bg-red-100 { background-color: #fecaca; }
    button:hover.bg-yellow-600 { background-color: #a16207; }
    button:hover.bg-gray-200 { background-color: #d1d5db; }
    
    input, select, textarea { border: 1px solid #d1d5db; font-size: 0.875rem; font-family: inherit; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    textarea { resize: vertical; }
    
    .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 0.5rem; max-width: 56rem; width: 100%; max-height: 90vh; overflow-y: auto; }
    
    .grid { display: grid; }
    .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    
    .ha-logo { height: 32px; width: 32px; }
    .header-title { display: flex; align-items: center; gap: 12px; }
  
    /* Dark Mode - v0.4.0 */
    @media (prefers-color-scheme: dark) {
      body { background: #111827; color: #f3f4f6; }
      .bg-gray-50 { background: #111827; }
      .bg-gray-100 { background: #1f2937; }
      .bg-gray-200 { background: #374151; }
      .bg-white { background: #1f2937; }
      .text-gray-500 { color: #9ca3af; }
      .text-gray-600 { color: #d1d5db; }
      .text-gray-700 { color: #e5e7eb; }
      .text-gray-800 { color: #f3f4f6; }
      .border { border-color: #374151; }
      .border-t, .border-b { border-top-color: #374151; border-bottom-color: #374151; }
      input, select, textarea { background: #374151; color: #f3f4f6; border-color: #4b5563; }
      input:focus, select:focus, textarea:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.2); }
      .modal { background: rgba(0,0,0,0.8); }
      .modal-content { background: #1f2937; border: 1px solid #374151; }
      .bg-green-50 { background: #064e3b; }
      .bg-green-100 { background: #065f46; }
      .text-green-600 { color: #34d399; }
      .text-green-700 { color: #10b981; }
      .text-green-800 { color: #059669; }
      .border-green-200 { border-color: #065f46; }
      .bg-red-100 { background: #7f1d1d; }
      .text-red-600 { color: #f87171; }
      .bg-yellow-50 { background: #78350f; }
      .bg-yellow-100 { background: #92400e; }
      .text-yellow-600 { color: #fbbf24; }
      .border-yellow-200 { border-color: #92400e; }
      .bg-orange-100 { background: #7c2d12; }
      .text-orange-800 { color: #fb923c; }
      .bg-purple-100 { background: #581c87; }
      .text-purple-800 { color: #c084fc; }
      .bg-pink-100 { background: #831843; }
      .text-pink-800 { color: #f472b6; }
    }
  </style>
</head>
<body class="min-h-screen bg-gray-50">
  <div id="app" class="py-6">
    <div class="max-w-6xl px-6">
      <div class="bg-white shadow rounded-lg">
        <div class="p-4 border-b flex justify-between items-center">
          <div class="header-title">
            <svg class="ha-logo" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path fill="#41BDF5" d="M21.8 13h-5.8l3.4-7.2c.3-.6.1-1.3-.4-1.7-.6-.3-1.3-.1-1.7.4l-5.3 8.5-5.3-8.5c-.4-.5-1.1-.7-1.7-.4-.5.4-.7 1.1-.4 1.7L8 13H2.2c-.7 0-1.2.5-1.2 1.2 0 .7.5 1.2 1.2 1.2h6.5l-3.3 7c-.3.6-.1 1.3.4 1.7.2.1.4.2.6.2.4 0 .8-.2 1-.5l5.3-8.5 5.3 8.5c.3.3.7.5 1 .5.2 0 .4-.1.6-.2.5-.4.7-1.1.4-1.7l-3.3-7h6.5c.7 0 1.2-.5 1.2-1.2 0-.7-.5-1.2-1.2-1.2z"/>
            </svg>
            <div>
              <h1 class="text-2xl font-bold">Home Assistant Release Notes Manager</h1>
              <p class="text-sm text-gray-500" id="save-status"></p>
            </div>
          </div>
          <div class="flex gap-3">
            <button class="px-4 py-2 bg-gray-200 rounded" onclick="showCategoriesManager()">‚öô Kategorien</button>
            <button class="px-4 py-2 bg-blue-600 text-white rounded" onclick="createNewRelease()">+ Neues Release</button>
          </div>
        </div>
        <div class="p-4 border-b flex gap-3">
          <input type="text" id="search-input" placeholder="Suchen..." class="flex-1 px-3 py-2 rounded"/>
          <select id="category-filter" class="px-3 py-2 rounded"><option value="all">Alle Kategorien</option></select>
          <button class="px-4 py-2 bg-gray-200 rounded" onclick="loadData()">üîÑ Aktualisieren</button>
        </div>
      </div>
      <div id="releases-container" class="mt-4">
        <div class="text-center py-12 text-gray-500">Lade Releases...</div>
      </div>
    </div>
  </div>
  <div id="modal" class="modal"><div class="modal-content p-6"></div></div>

  <script>
    const state = {
      releases: [],
      knownIssues: [],
      categories: [
        { id: 'general', label: 'Allgemein', color: 'bg-gray-100 text-gray-800' },
        { id: 'heating', label: 'Heizung', color: 'bg-orange-100 text-orange-800' },
        { id: 'energy', label: 'Energie', color: 'bg-green-100 text-green-800' },
        { id: 'automation', label: 'Automation', color: 'bg-blue-600 text-white' },
        { id: 'device', label: 'Ger√§t', color: 'bg-purple-100 text-purple-800' },
        { id: 'integration', label: 'Integration', color: 'bg-pink-100 text-pink-800' }
      ],
      expandedReleases: new Set(),
      searchTerm: '',
      filterCategory: 'all',
      editingRelease: null,
      editingCatId: null,
      editingCatLabel: '',
      resolvingIssueId: null,
      resolvingSolution: '',
      resolveVersion: ''
    };

    // Datumsformat: DD.MM.YYYY
    function formatDateDE(isoDate) {
      if (!isoDate) return '';
      const [year, month, day] = isoDate.split('-');
      return `${day}.${month}.${year}`;
    }

    // Keyboard Shortcuts - v0.4.0
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.key === 's') { e.preventDefault(); saveData(); }
      if (e.key === 'Escape') { document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')); }
    });
    
    async function loadData() {
      console.log('üì• Lade Daten...');
      try {
        const response = await fetch('/local/release_data.json?t=' + Date.now());
        if (response.ok) {
          const data = await response.json();
          console.log('‚úÖ Geladen:', data);
          state.releases = data.releases || [];
          state.knownIssues = data.knownIssues || [];
          state.categories = data.categories || state.categories;
        }
      } catch (e) { console.log('‚ÑπÔ∏è Erstmalige Nutzung'); }
      render();
    }

    function exportMarkdown(releaseId) {
      const release = state.releases.find(r => r.id === releaseId);
      if (!release) return;
      let md = `# Release ${release.version}`;
      if (release.name) md += ` - ${release.name}`;
      md += `

**Datum:** ${formatDateDE(release.date)}

`;
      if (release.features?.length > 0) {
        md += `## ‚ú® Neue Features

`;
        release.features.forEach(f => {
          const cat = state.categories.find(c => c.id === f.category);
          md += `- **[${cat?.label||'Allgemein'}]** ${f.title}`;
          if (f.details) md += `
  ${f.details}`;
          md += `
`;
        });
        md += `
`;
      }
      if (release.changes?.length > 0) {
        md += `## üîÑ √Ñnderungen / Bugfixes

`;
        release.changes.forEach(c => {
          const cat = state.categories.find(ct => ct.id === c.category);
          md += `- **[${cat?.label||'Allgemein'}]** ${c.title}
`;
        });
        md += `
`;
      }
      if (release.knownIssues?.length > 0) {
        md += `## ‚ö†Ô∏è Bekannte Fehler

`;
        release.knownIssues.forEach(i => {
          const cat = state.categories.find(ct => ct.id === i.category);
          md += `- **[${cat?.label||'Allgemein'}]** ${i.title}`;
          if (i.status === 'resolved') md += ` ‚úì Gel√∂st in ${i.resolvedInVersion}`;
          md += `
`;
        });
        md += `
`;
      }
      if (release.comments) md += `## üí¨ Kommentare

${release.comments}
`;
      const blob = new Blob([md], {type: 'text/markdown'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `release-${release.version}.md`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    async function saveData() {
      console.log('üíæ Speichere OHNE Auth...');
      setSaveStatus('Speichere...');
      const data = { releases: state.releases, knownIssues: state.knownIssues, categories: state.categories, lastUpdate: new Date().toISOString() };
      try {
        console.log('üì§ POST /api/release_notes_manager/save');
        const response = await fetch('/api/release_notes_manager/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ data: JSON.stringify(data) })
        });
        if (response.ok) {
          console.log('‚úÖ Gespeichert');
          setSaveStatus('‚úÖ Gespeichert!');
          setTimeout(() => setSaveStatus(''), 3000);
          return true;
        }
        throw new Error(`API ${response.status}`);
      } catch (e) {
        console.error('‚ùå Fehler:', e);
        setSaveStatus('‚ùå Fehler!');
        alert(`Speichern fehlgeschlagen!\n\n${e.message}`);
        return false;
      }
    }

    function setSaveStatus(text) { document.getElementById('save-status').textContent = text; }

    // Neues Release mit AUTO-√úBERNAHME offener Fehler
    function createNewRelease() {
      const today = new Date().toISOString().split('T')[0];
      
      // üéØ √úbernehme alle NICHT gel√∂sten Fehler
      const openIssues = state.knownIssues.filter(issue => issue.status !== 'resolved');
      console.log(`üìã √úbernehme ${openIssues.length} offene Fehler in neues Release`);
      
      state.editingRelease = { 
        id: Date.now(), 
        version: '', 
        date: today, 
        features: [], 
        changes: [], 
        knownIssues: JSON.parse(JSON.stringify(openIssues)), // Deep copy
        comments: '' 
      };
      
      showModal('release');
    }

    async function saveRelease() {
      if (!state.editingRelease || !state.editingRelease.version) { 
        alert('Bitte Version eingeben!'); 
        return; 
      }
      
      const isNew = !state.releases.find(r => r.id === state.editingRelease.id);
      state.releases = isNew ? [state.editingRelease, ...state.releases] : state.releases.map(r => r.id === state.editingRelease.id ? state.editingRelease : r);
      
      // Update globale Known Issues Liste
      state.knownIssues = state.editingRelease.knownIssues;
      
      if (await saveData()) { 
        hideModal(); 
        state.editingRelease = null; 
        render(); 
      }
    }

    function editRelease(id) { 
      state.editingRelease = JSON.parse(JSON.stringify(state.releases.find(r => r.id === id))); 
      showModal('release'); 
    }
    
    async function deleteRelease(id) { 
      if (!confirm('Release l√∂schen?')) return; 
      state.releases = state.releases.filter(r => r.id !== id); 
      await saveData(); 
      render(); 
    }
    
    function toggleRelease(id) { 
      state.expandedReleases.has(id) ? state.expandedReleases.delete(id) : state.expandedReleases.add(id); 
      render(); 
    }

    function addItem(type) { 
      state.editingRelease[type].unshift({ id: Date.now(), title: '', details: '', category: 'general' }); 
      renderModal(); 
    }
    
    function updateItem(type, id, field, value) { 
      state.editingRelease[type] = state.editingRelease[type].map(item => item.id === id ? { ...item, [field]: value } : item); 
    }
    
    function removeItem(type, id) { 
      state.editingRelease[type] = state.editingRelease[type].filter(item => item.id !== id); 
      renderModal(); 
    }

    function addKnownIssue() { 
      state.editingRelease.knownIssues.unshift({ id: Date.now(), title: '', details: '', category: 'general', status: 'open' }); 
      renderModal(); 
    }
    
    function updateKnownIssue(id, field, value) { 
      state.editingRelease.knownIssues = state.editingRelease.knownIssues.map(i => i.id === id ? { ...i, [field]: value } : i); 
    }
    
    function removeKnownIssue(id) { 
      state.editingRelease.knownIssues = state.editingRelease.knownIssues.filter(i => i.id !== id); 
      renderModal(); 
    }
    
    function startResolveIssue(id) { 
      state.resolvingIssueId = id; 
      state.resolvingSolution = ''; 
      state.resolveVersion = state.editingRelease.version; 
      renderModal(); 
    }
    
    function confirmResolveIssue() {
      if (!state.resolvingIssueId) return;
      const issue = state.editingRelease.knownIssues.find(i => i.id === state.resolvingIssueId);
      if (!issue) return;
      
      // Als Change dokumentieren
      if (state.resolvingSolution.trim()) {
        state.editingRelease.changes.push({ 
          id: Date.now(), 
          title: `Gel√∂st: ${issue.title}`, 
          details: state.resolvingSolution.trim(), 
          category: issue.category || 'general' 
        });
      }
      
      // Fehler als gel√∂st markieren (nicht l√∂schen!)
      state.editingRelease.knownIssues = state.editingRelease.knownIssues.map(i => 
        i.id === state.resolvingIssueId 
          ? { ...i, status: 'resolved', resolvedInVersion: state.resolveVersion, resolution: state.resolvingSolution }
          : i
      );
      
      state.resolvingIssueId = null; 
      state.resolvingSolution = ''; 
      state.resolveVersion = '';
      renderModal();
    }
    
    function cancelResolveIssue() { 
      state.resolvingIssueId = null; 
      state.resolvingSolution = ''; 
      state.resolveVersion = ''; 
      renderModal(); 
    }

    function showCategoriesManager() { showModal('categories'); }
    
    async function addCategory() {
      const label = document.getElementById('new-cat-input').value.trim();
      if (!label) return;
      const colors = ['bg-gray-100 text-gray-800', 'bg-orange-100 text-orange-800'];
      state.categories.push({ id: `custom_${Date.now()}`, label, color: colors[state.categories.length % colors.length] });
      await saveData();
      document.getElementById('new-cat-input').value = '';
      renderModal();
    }
    
    function startEditCat(id, label) { state.editingCatId = id; state.editingCatLabel = label; renderModal(); }
    
    async function saveEditCat() {
      if (!state.editingCatLabel.trim()) return;
      state.categories = state.categories.map(c => c.id === state.editingCatId ? { ...c, label: state.editingCatLabel.trim() } : c);
      await saveData();
      state.editingCatId = null; state.editingCatLabel = '';
      renderModal();
    }
    
    function cancelEditCat() { state.editingCatId = null; state.editingCatLabel = ''; renderModal(); }
    
    async function deleteCategory(id) { 
      if (!confirm('Kategorie l√∂schen?')) return; 
      state.categories = state.categories.filter(c => c.id !== id); 
      await saveData(); 
      renderModal(); 
    }

    function showModal(type) { 
      document.getElementById('modal').classList.add('active'); 
      document.getElementById('modal').dataset.type = type; 
      renderModal(); 
    }
    
    function hideModal() { 
      document.getElementById('modal').classList.remove('active'); 
      state.editingRelease = null; 
      state.resolvingIssueId = null; 
    }

    function render() { renderCategoryFilter(); renderReleases(); }
    
    function renderCategoryFilter() {
      const select = document.getElementById('category-filter');
      select.innerHTML = '<option value="all">Alle Kategorien</option>' + [...state.categories].sort((a,b)=>a.label.localeCompare(b.label,'de')).map(cat => `<option value="${cat.id}" ${state.filterCategory === cat.id ? 'selected' : ''}>${cat.label}</option>`).join('');
    }
    
    function renderReleases() {
      const filtered = state.releases.filter(r => {
        const matchSearch = !state.searchTerm || JSON.stringify(r).toLowerCase().includes(state.searchTerm.toLowerCase());
        const matchCat = state.filterCategory === 'all' || r.features.some(f => f.category === state.filterCategory) || r.changes.some(c => c.category === state.filterCategory);
        return matchSearch && matchCat;
      });
      const container = document.getElementById('releases-container');
      container.innerHTML = filtered.length === 0 ? '<div class="text-center py-12 text-gray-500"><p class="text-xl font-semibold mb-2">Keine Releases</p><p>Erstelle dein erstes Release!</p></div>' : filtered.map(r => renderRelease(r)).join('');
    }
    
    function renderRelease(release) {
      const expanded = state.expandedReleases.has(release.id);
      const getCat = id => state.categories.find(c => c.id === id) || { label: id, color: 'bg-gray-100 text-gray-800' };
      const openIssues = (release.knownIssues || []).filter(i => i.status !== 'resolved');
      
      return `
        <div class="bg-white shadow rounded-lg mb-4">
          <div class="p-4 flex justify-between items-start cursor-pointer" onclick="toggleRelease(${release.id})">
            <div><h2 class="text-xl font-bold text-blue-600">Version ${esc(release.version)}</h2><p class="text-sm text-gray-600">${formatDateDE(release.date)}</p>
            <div class="text-sm text-gray-600" style="margin-top:0.5rem;display:flex;gap:0.75rem;flex-wrap:wrap;">
              <span>${release.features.length} Features</span><span>‚Ä¢</span>
              <span>${release.changes.length} √Ñnderungen</span><span>‚Ä¢</span>
              <span>${release.knownIssues.filter(i=>i.status==='open').length} offene Bugs</span><span>‚Ä¢</span>
              <span>${release.knownIssues.filter(i=>i.status==='resolved').length} gel√∂st</span>
            </div></div>
            <div class="flex gap-2" onclick="event.stopPropagation()">
              <button class="px-3 py-1 bg-gray-200 rounded" onclick="editRelease(${release.id})" title="Bearbeiten">‚úèÔ∏è</button>
              <button onclick="exportMarkdown('${release.id}')" class="bg-gray-200 px-3 py-1 rounded text-sm" title="Als Markdown exportieren">üìÑ Export MD</button>
              <button class="px-3 py-1 bg-red-600 text-white rounded" onclick="deleteRelease(${release.id})">L√∂schen</button>
            </div>
          </div>
          ${expanded ? `<div class="border-t p-4">
            ${release.features && release.features.length > 0 ? `<div class="mb-4"><h3 class="text-xl font-semibold mb-3">‚ú® Neue Features</h3>${release.features.map(f => { const cat = getCat(f.category); return `<div class="flex gap-2 mb-3"><span class="px-2 py-1 rounded text-sm ${cat.color}">${cat.label}</span><div class="flex-1"><div class="font-medium">${esc(f.title)}</div>${f.details ? `<p class="text-sm text-gray-600">${esc(f.details)}</p>` : ''}</div></div>`; }).join('')}</div>` : ''}
            ${release.changes && release.changes.length > 0 ? `<div class="mb-4"><h3 class="text-xl font-semibold mb-3">üîÑ √Ñnderungen / Bugfixes</h3>${release.changes.map(c => { const cat = getCat(c.category); return `<div class="flex gap-2 mb-3"><span class="px-2 py-1 rounded text-sm ${cat.color}">${cat.label}</span><div class="flex-1"><div class="font-medium">${esc(c.title)}</div>${c.details ? `<p class="text-sm text-gray-600">${esc(c.details)}</p>` : ''}</div></div>`; }).join('')}</div>` : ''}
            ${openIssues.length > 0 ? `<div class="mb-4"><h3 class="text-xl font-semibold mb-3">‚ö†Ô∏è Bekannte Fehler</h3>${openIssues.map(i => { const cat = getCat(i.category); return `<div class="border border-yellow-200 rounded p-3 mb-2 bg-yellow-50"><div class="flex gap-2 items-start"><span class="px-2 py-1 rounded text-sm ${cat.color}">${cat.label}</span><div class="flex-1"><div class="font-medium">${esc(i.title)}</div>${i.details ? `<p class="text-sm text-gray-600">${esc(i.details)}</p>` : ''}</div></div></div>`; }).join('')}</div>` : ''}
            ${release.comments ? `<div class="text-sm text-gray-600 bg-gray-50 p-3 rounded">${esc(release.comments)}</div>` : ''}
          </div>` : ''}
        </div>`;
    }
    
    function renderModal() {
      const modal = document.getElementById('modal');
      const content = modal.querySelector('.modal-content');
      const type = modal.dataset.type;
      
      if (type === 'categories') {
        content.innerHTML = `<div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Kategorien verwalten</h2><button class="px-4 py-2 bg-gray-200 rounded" onclick="hideModal()">Schlie√üen</button></div>
          <div class="mb-6"><label class="block text-sm font-medium mb-2">Neue Kategorie</label><div class="flex gap-2"><input type="text" id="new-cat-input" placeholder="Name..." class="flex-1 px-3 py-2 rounded" onkeypress="if(event.key==='Enter')addCategory()"/><button class="px-4 py-2 bg-blue-600 text-white rounded" onclick="addCategory()">+ Hinzuf√ºgen</button></div></div>
          ${state.categories.map(c => state.editingCatId === c.id ? `<div class="flex gap-2 items-center p-3 border rounded mb-2"><input type="text" value="${esc(state.editingCatLabel)}" oninput="state.editingCatLabel=this.value" class="flex-1 px-2 py-1 rounded" onkeypress="if(event.key==='Enter')saveEditCat()"/><button class="px-3 py-1 bg-green-600 text-white rounded" onclick="saveEditCat()">Speichern</button><button class="px-3 py-1 bg-gray-200 rounded" onclick="cancelEditCat()">Abbrechen</button></div>` : `<div class="flex justify-between items-center p-3 border rounded mb-2"><span class="px-3 py-1 rounded text-sm ${c.color}">${c.label}</span><div class="flex gap-2"><button class="px-3 py-1 bg-gray-200 rounded" onclick="startEditCat('${c.id}','${esc(c.label)}')">Bearbeiten</button><button class="px-3 py-1 bg-red-100 text-red-600 rounded" onclick="deleteCategory('${c.id}')">L√∂schen</button></div></div>`).join('')}`;
      } else if (type === 'release' && state.editingRelease) {
        const r = state.editingRelease;
        const isNew = !state.releases.find(rel => rel.id === r.id);
        const openIssuesCount = r.knownIssues.filter(i => i.status !== 'resolved').length;
        
        content.innerHTML = `<div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">${isNew ? 'Neues Release' : 'Release bearbeiten'}</h2><div class="flex gap-2"><button class="px-4 py-2 bg-gray-200 rounded" onclick="hideModal()">Abbrechen</button><button class="px-4 py-2 bg-blue-600 text-white rounded" onclick="saveRelease()">Speichern</button></div></div>
          ${isNew && openIssuesCount > 0 ? `<div class="bg-yellow-50 border border-yellow-200 rounded p-3 mb-4"><p class="text-sm"><strong>‚ÑπÔ∏è ${openIssuesCount} offene Fehler</strong> wurden automatisch √ºbernommen</p></div>` : ''}
          <div class="grid grid-cols-2 gap-4 mb-4"><div><label class="block text-sm font-medium mb-2">Version *</label><input type="text" value="${esc(r.version)}" oninput="state.editingRelease.version=this.value" class="w-full px-3 py-2 rounded" placeholder="z.B. 2025.1.1"/></div><div><label class="block text-sm font-medium mb-2">Datum</label><input type="date" value="${r.date}" oninput="state.editingRelease.date=this.value" class="w-full px-3 py-2 rounded"/></div></div>
          <div class="border-t pt-4 mb-4"><div class="flex justify-between mb-3"><h3 class="text-xl font-semibold">‚ú® Neue Features</h3><button class="px-3 py-1 bg-green-600 text-white rounded" onclick="addItem('features')">+ Hinzuf√ºgen</button></div>${r.features.map(f => `<div class="border rounded p-3 mb-3 bg-gray-50"><div class="flex gap-2 mb-2"><input type="text" value="${esc(f.title)}" oninput="updateItem('features',${f.id},'title',this.value)" placeholder="Titel..." class="flex-1 px-2 py-1 rounded"/><select onchange="updateItem('features',${f.id},'category',this.value)" class="px-2 py-1 rounded">${state.categories.map(c => `<option value="${c.id}" ${f.category===c.id?'selected':''}>${c.label}</option>`).join('')}</select><button class="px-2 py-1 bg-red-100 text-red-600 rounded" onclick="removeItem('features',${f.id})">√ó</button></div><textarea oninput="updateItem('features',${f.id},'details',this.value)" placeholder="Details..." class="w-full px-2 py-1 rounded" rows="3">${esc(f.details||'')}</textarea></div>`).join('')}${r.features.length === 0 ? '<p class="text-gray-500 italic">Keine Features</p>' : ''}</div>
          <div class="border-t pt-4 mb-4"><div class="flex justify-between mb-3"><h3 class="text-xl font-semibold">üîÑ √Ñnderungen / Bugfixes</h3><button class="px-3 py-1 bg-green-600 text-white rounded" onclick="addItem('changes')">+ Hinzuf√ºgen</button></div>${r.changes.map(c => `<div class="border rounded p-3 mb-3 bg-gray-50"><div class="flex gap-2 mb-2"><input type="text" value="${esc(c.title)}" oninput="updateItem('changes',${c.id},'title',this.value)" placeholder="Titel..." class="flex-1 px-2 py-1 rounded"/><select onchange="updateItem('changes',${c.id},'category',this.value)" class="px-2 py-1 rounded">${[...state.categories].sort((a,b)=>a.label.localeCompare(b.label,'de')).map(cat => `<option value="${cat.id}" ${c.category===cat.id?'selected':''}>${cat.label}</option>`).join('')}</select><button class="px-2 py-1 bg-red-100 text-red-600 rounded" onclick="removeItem('changes',${c.id})">√ó</button></div><textarea oninput="updateItem('changes',${c.id},'details',this.value)" placeholder="Details..." class="w-full px-2 py-1 rounded" rows="3">${esc(c.details||'')}</textarea></div>`).join('')}${r.changes.length === 0 ? '<p class="text-gray-500 italic">Keine √Ñnderungen</p>' : ''}</div>
          <div class="border-t pt-4 mb-4"><div class="flex justify-between mb-3"><h3 class="text-xl font-semibold">‚ö†Ô∏è Bekannte Fehler</h3><button class="px-3 py-1 bg-yellow-600 text-white rounded" onclick="addKnownIssue()">+ Hinzuf√ºgen</button></div>${r.knownIssues.map(i => state.resolvingIssueId === i.id ? `<div class="space-y-3"><div class="bg-green-50 border border-green-200 rounded p-3"><h4 class="font-semibold text-green-800 mb-2">‚úì Fehler als gel√∂st markieren</h4><p class="text-sm text-green-700 mb-3">Fehler: <strong>${esc(i.title)}</strong></p><div class="space-y-2"><label class="block text-sm font-medium text-gray-700">In Version gel√∂st (optional):</label><input type="text" value="${esc(state.resolveVersion)}" oninput="state.resolveVersion=this.value" placeholder="${r.version}" class="w-full px-3 py-2 border rounded"/><label class="block text-sm font-medium text-gray-700 mt-3">Beschreibung der L√∂sung (optional):</label><textarea oninput="state.resolvingSolution=this.value" placeholder="Beschreibe wie der Fehler gel√∂st wurde..." class="w-full px-3 py-2 border rounded" rows="3">${esc(state.resolvingSolution)}</textarea></div><div class="flex gap-2 mt-3"><button class="px-4 py-2 bg-green-600 text-white rounded" onclick="confirmResolveIssue()">${state.resolvingSolution.trim() ? 'L√∂sung dokumentieren' : 'Als gel√∂st markieren'}</button><button class="px-4 py-2 bg-gray-200 rounded" onclick="cancelResolveIssue()">Abbrechen</button></div></div></div>` : i.status === 'resolved' ? `<div class="border border-green-200 rounded p-3 mb-3 bg-green-50"><div class="flex gap-2 mb-2"><span class="px-2 py-1 rounded text-sm bg-green-100 text-green-800">‚úì Gel√∂st in v${esc(i.resolvedInVersion||'?')}</span><div class="flex-1"><div class="font-medium text-gray-600 line-through">${esc(i.title)}</div>${i.resolution ? `<p class="text-sm text-gray-600">${esc(i.resolution)}</p>` : ''}</div></div></div>` : `<div class="border border-yellow-200 rounded p-3 mb-3 bg-yellow-50"><div class="flex gap-2 mb-2"><input type="text" value="${esc(i.title)}" oninput="updateKnownIssue(${i.id},'title',this.value)" placeholder="Fehler..." class="flex-1 px-2 py-1 rounded"/><select onchange="updateKnownIssue(${i.id},'category',this.value)" class="px-2 py-1 rounded">${[...state.categories].sort((a,b)=>a.label.localeCompare(b.label,'de')).map(cat => `<option value="${cat.id}" ${(i.category||'general')===cat.id?'selected':''}>${cat.label}</option>`).join('')}</select><button class="px-2 py-1 bg-green-100 text-green-600 rounded" onclick="startResolveIssue(${i.id})" title="Als gel√∂st markieren">‚úì Gel√∂st</button><button class="px-2 py-1 bg-red-100 text-red-600 rounded" onclick="removeKnownIssue(${i.id})">√ó</button></div><textarea oninput="updateKnownIssue(${i.id},'details',this.value)" placeholder="Details..." class="w-full px-2 py-1 rounded" rows="2">${esc(i.details||'')}</textarea></div>`).join('')}${r.knownIssues.length === 0 ? '<p class="text-gray-500 italic">Keine bekannten Fehler</p>' : ''}</div>
          <div class="border-t pt-4"><label class="block text-sm font-medium mb-2">Kommentare (optional)</label><textarea oninput="state.editingRelease.comments=this.value" class="w-full px-3 py-2 rounded" rows="3" placeholder="Zus√§tzliche Informationen...">${esc(r.comments||'')}</textarea></div>`;
      }
    }
    
    function esc(text) { const div = document.createElement('div'); div.textContent = text || ''; return div.innerHTML; }

    document.getElementById('search-input').addEventListener('input', e => { state.searchTerm = e.target.value; render(); });
    document.getElementById('category-filter').addEventListener('change', e => { state.filterCategory = e.target.value; render(); });

    console.log('üöÄ Home Assistant Release Notes Manager v0.3.0 startet...');
    loadData();
  </script>
</body>
</html>
