<!DOCTYPE html>
<html lang="de">
<head>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="version" content="0.5.0">

  <meta charset="UTF-8">
  <meta name="version" content="0.5.0">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home Assistant Release Notes Manager v0.5.0</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: #f9fafb; color: #111827; }
    .min-h-screen { min-height: 100vh; }
    .bg-gray-50 { background-color: #f9fafb; }
    .bg-gray-100 { background-color: #f3f4f6; }
    .bg-gray-200 { background-color: #e5e7eb; }
    .bg-white { background-color: #ffffff; }
    .bg-blue-600 { background-color: #2563eb; }
    .bg-green-50 { background-color: #f0fdf4; }
    .bg-green-100 { background-color: #dcfce7; }
    .bg-green-600 { background-color: #16a34a; }
    .bg-red-100 { background-color: #fee2e2; }
    .bg-red-600 { background-color: #dc2626; }
    .bg-yellow-50 { background-color: #fefce8; }
    .bg-yellow-100 { background-color: #fef9c3; }
    .bg-yellow-600 { background-color: #ca8a04; }
    .bg-orange-100 { background-color: #ffedd5; }
    .bg-purple-100 { background-color: #f3e8ff; }
    .bg-pink-100 { background-color: #fce7f3; }
    .text-white { color: #ffffff; }
    .text-gray-500 { color: #6b7280; }
    .text-gray-600 { color: #4b5563; }
    .text-gray-700 { color: #374151; }
    .text-gray-800 { color: #1f2937; }
    .text-red-600 { color: #dc2626; }
    .text-blue-600 { color: #2563eb; }
    .text-green-600 { color: #16a34a; }
    .text-green-700 { color: #15803d; }
    .text-green-800 { color: #166534; }
    .text-orange-800 { color: #9a3412; }
    .text-purple-800 { color: #6b21a8; }
    .text-pink-800 { color: #9f1239; }
    .text-yellow-600 { color: #ca8a04; }
    .border-green-200 { border-color: #bbf7d0; }
    .border-yellow-200 { border-color: #fef08a; }
    .p-3 { padding: 0.75rem; }
    .p-4 { padding: 1rem; }
    .p-6 { padding: 1.5rem; }
    .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
    .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
    .px-4 { padding-left: 1rem; padding-right: 1rem; }
    .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
    .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
    .py-6 { padding-top: 1.5rem; padding-bottom: 1.5rem; }
    .pt-4 { padding-top: 1rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mb-3 { margin-bottom: 0.75rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-6 { margin-bottom: 1.5rem; }
    .mt-3 { margin-top: 0.75rem; }
    .max-w-6xl { max-width: 72rem; margin-left: auto; margin-right: auto; }
    .flex { display: flex; }
    .flex-1 { flex: 1; }
    .gap-2 { gap: 0.5rem; }
    .gap-3 { gap: 0.75rem; }
    .items-center { align-items: center; }
    .items-start { align-items: flex-start; }
    .justify-between { justify-content: space-between; }
    .rounded { border-radius: 0.25rem; }
    .rounded-lg { border-radius: 0.5rem; }
    .border { border: 1px solid #e5e7eb; }
    .border-t { border-top: 1px solid #e5e7eb; }
    .border-b { border-bottom: 1px solid #e5e7eb; }
    .shadow { box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); }
    .text-sm { font-size: 0.875rem; }
    .text-xl { font-size: 1.25rem; }
    .text-2xl { font-size: 1.5rem; }
    .font-bold { font-weight: 700; }
    .font-semibold { font-weight: 600; }
    .font-medium { font-weight: 500; }
    .italic { font-style: italic; }
    .line-through { text-decoration: line-through; }
    .w-full { width: 100%; }
    .block { display: block; }
    .hidden { display: none; }
    .cursor-pointer { cursor: pointer; }
    .space-y-2 > * + * { margin-top: 0.5rem; }
    .space-y-3 > * + * { margin-top: 0.75rem; }
    button { border: none; cursor: pointer; transition: all 0.15s; font-size: 0.875rem; }
    button:hover.bg-blue-600 { background-color: #1d4ed8; }
    button:hover.bg-green-600 { background-color: #15803d; }
    button:hover.bg-green-100 { background-color: #bbf7d0; }
    button:hover.bg-red-600 { background-color: #b91c1c; }
    button:hover.bg-red-100 { background-color: #fecaca; }
    button:hover.bg-yellow-600 { background-color: #a16207; }
    button:hover.bg-yellow-100 { background-color: #fef08a; }
    button:hover.bg-gray-200 { background-color: #d1d5db; }
    input, select, textarea { border: 1px solid #d1d5db; font-size: 0.875rem; font-family: inherit; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    textarea { resize: vertical; }
    .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 0.5rem; max-width: 56rem; width: 100%; max-height: 90vh; overflow-y: auto; }
    .grid { display: grid; }
    .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .ha-logo { height: 32px; width: 32px; }
    .header-title { display: flex; align-items: center; gap: 12px; }
  
    .bg-gray-800 { background-color: #1f2937; }
    .bg-gray-900 { background-color: #111827; }
    .bg-blue-100 { background-color: #dbeafe; }
    .bg-blue-200 { background-color: #bfdbfe; }
    .text-gray-800 { color: #1f2937; }
    .text-gray-900 { color: #111827; }
    .text-blue-800 { color: #1e40af; }
    .text-blue-900 { color: #1e3a8a; }
    .text-red-800 { color: #991b1b; }
    .text-orange-800 { color: #9a3412; }
    .text-yellow-900 { color: #713f12; }
    .text-green-800 { color: #166534; }
    .text-purple-800 { color: #6b21a8; }
    .text-pink-800 { color: #9f1239; }
    .border-gray-300 { border-color: #d1d5db; }

    .w-40 { width: 8rem; hyphens: auto; -webkit-hyphens: auto; -ms-hyphens: auto; word-wrap: break-word; }
    .text-center { text-align: center; }
    .pl-3 { padding-left: 0.75rem; }

    /* Neuestes Release - NUR der Header-Bereich blau */
    #releases-container > div:first-child > div.p-4.flex.justify-between {
      background-color: #2563eb !important;
      border-radius: 0.5rem 0.5rem 0 0;
    }
    #releases-container > div:first-child > div.p-4.flex.justify-between h2 {
      color: #ffffff !important;
    }
    #releases-container > div:first-child > div.p-4.flex.justify-between p {
      color: #ffffff !important;
    }
    .mt-8 { margin-top: 2rem; }

    /* Stelle sicher dass rounded-lg wirkt */
    #releases-container > div:first-child {
      overflow: hidden;
    }
    .bg-blue-500 { background-color: #3b82f6; }
    .bg-yellow-500 { background-color: #eab308; }
    .text-black { color: #000000; }
    .text-xs { font-size: 0.75rem; line-height: 1rem; }

    /* Badges mit Grid - absolut zentriert */
    .release-badges {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: grid;
      grid-template-columns: 90px 110px 80px;
      gap: 0.5rem;
      align-items: center;
    }
    .release-header-wrapper {
      display: block;
    }
    .release-top-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.5rem;
    }
    .release-bottom-row {
      position: relative;
      display: flex;
      align-items: center;
      min-height: 2rem;
      margin-top: 0.25rem;
    }

    .release-title {
      white-space: nowrap;
    }

    /* Feste Breiten f√ºr Badge-Typen */
    .badge-features {
      min-width: 90px;
      text-align: center;
    }
    .badge-changes {
      min-width: 110px;
      text-align: center;
    }
    .badge-issues {
      min-width: 80px;
      text-align: center;
    }

    /* Feature 8: Neuestes Release - nur Header blau */
    #releases-container > div:first-child {
      overflow: hidden;
    }
    #releases-container > div:first-child > .release-header-wrapper {
      background-color: #2563eb !important;
    }
    #releases-container > div:first-child > .release-header-wrapper h2 {
      color: #ffffff !important;
    }
    #releases-container > div:first-child > .release-header-wrapper p {
      color: #ffffff !important;
    }
    #releases-container > div:first-child > .release-header-wrapper button {
      background-color: rgba(255, 255, 255, 0.2) !important;
    }
</style>
</head>
<body class="min-h-screen bg-gray-50">
  <div id="app" class="py-6">
    <div class="max-w-6xl px-6">
      <div class="bg-white shadow rounded-lg">
        <div class="p-4 border-b flex justify-between items-center">
          <div class="header-title">
            <svg class="ha-logo" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
              <path fill="#41BDF5" d="M42 18L24 6 6 18v24h36V18zM24 10l14 9v19H10V19l14-9z"/>
              <circle fill="#FFFFFF" cx="15" cy="35" r="2"/>
              <circle fill="#FFFFFF" cx="24" cy="20" r="2"/>
              <circle fill="#FFFFFF" cx="33" cy="30" r="2"/>
              <path stroke="#FFFFFF" stroke-width="2" fill="none" d="M15 35 L24 20 M24 20 L33 30"/>
            </svg>
            <div>
              <h1 class="text-2xl font-bold">Home Assistant Release Notes Manager</h1>
              <p class="text-sm text-gray-500" id="save-status"></p>
            </div>
          </div>
          <div class="flex gap-3">
            <button class="px-4 py-2 bg-gray-200 rounded" onclick="showCategoriesManager()">‚öôÔ∏è Kategorien</button>
            <button class="px-4 py-2 bg-blue-600 text-white rounded" onclick="createNewRelease()">+ Neues Release</button>
          </div>
        </div>
        <div class="p-4 border-b flex gap-3">
          <input type="text" id="search-input" placeholder="Suchen..." class="flex-1 px-3 py-2 rounded"/>
          <select id="category-filter" class="px-3 py-2 rounded"><option value="all">Alle Kategorien</option></select>
          <button class="px-4 py-2 bg-gray-200 rounded" onclick="loadData()">üîÑ Aktualisieren</button>
        </div>
      </div>
      <div id="releases-container" class="mt-8"><div class="text-center py-12 text-gray-500">Lade Releases...</div></div>
    </div>
  </div>
  <div id="modal" class="modal"><div class="modal-content p-6"></div></div>
  <script>
const CATEGORY_COLORS = [
  {id: 'white', label: 'Wei√ü', class: 'bg-white text-gray-900 border border-gray-300'},
  {id: 'gray', label: 'Grau', class: 'bg-gray-200 text-gray-800'},
  {id: 'black', label: 'Schwarz', class: 'bg-gray-800 text-white'},
  {id: 'red', label: 'Rot', class: 'bg-red-100 text-red-800'},
  {id: 'orange', label: 'Orange', class: 'bg-orange-100 text-orange-800'},
  {id: 'yellow', label: 'Gelb', class: 'bg-yellow-100 text-yellow-900'},
  {id: 'green', label: 'Gr√ºn', class: 'bg-green-100 text-green-800'},
  {id: 'blue-light', label: 'Hellblau', class: 'bg-blue-200 text-blue-900'},
  {id: 'blue-dark', label: 'Dunkelblau', class: 'bg-blue-600 text-white'},
  {id: 'purple', label: 'Lila', class: 'bg-purple-100 text-purple-800'},
  {id: 'pink', label: 'Pink', class: 'bg-pink-100 text-pink-800'}
];

const state={releases:[],knownIssues:[],categories:[{id:'general',label:'Allgemein',color:'bg-gray-200 text-gray-800'},{id:'heating',label:'Heizung',color:'bg-orange-100 text-orange-800'},{id:'energy',label:'Energie',color:'bg-green-100 text-green-800'},{id:'automation',label:'Automation',color:'bg-blue-600 text-white'},{id:'device',label:'Ger√§t',color:'bg-purple-100 text-purple-800'},{id:'integration',label:'Integration',color:'bg-pink-100 text-pink-800'}],expandedReleases:new Set(),expandedDetails:new Set(),displayCount:10,searchTerm:'',filterCategory:'all',editingRelease:null,editingCatId:null,editingCatLabel:'',resolvingIssueId:null,resolvingSolution:'',resolveVersion:''};
function formatDateDE(d){if(!d)return'';const[y,m,day]=d.split('-');return`${day}.${m}.${y}`}
async function loadData(){console.log('üì• Lade Daten...');try{const r=await fetch('/api/release_notes_manager/data?t='+Date.now());if(r.ok){const d=await r.json();console.log('‚úÖ Geladen:',d);state.releases=d.releases||[];state.knownIssues=d.knownIssues||[];state.categories=d.categories||state.categories}}catch(e){console.log('‚ÑπÔ∏è Erstmalige Nutzung')}render()}

// Migriere alte Farbklassen zu neuen
function migrateColorClasses() {
  const colorMigrations = {
    'bg-gray-100 text-gray-800': 'bg-gray-200 text-gray-800',
    'bg-gray-900 text-white': 'bg-gray-800 text-white',
    'bg-blue-100 text-blue-800': 'bg-blue-200 text-blue-900',
    'bg-yellow-100 text-yellow-800': 'bg-yellow-100 text-yellow-900',
    'bg-blue-600 text-white': 'bg-blue-600 text-white'  // Dunkelblau bleibt
  };
  
  let migrated = false;
  state.categories = state.categories.map(cat => {
    if (colorMigrations[cat.color]) {
      const newColor = colorMigrations[cat.color];
      if (newColor !== cat.color) {
        console.log(`üé® Migriere ${cat.label}: ${cat.color} ‚Üí ${newColor}`);
        migrated = true;
        return {...cat, color: newColor};
      }
    }
    return cat;
  });
  
  if (migrated) {
    console.log('‚úÖ Farben migriert, speichere...');
    saveData();
  }
}
async function saveData(){console.log('üíæ Speichere...');setSaveStatus('Speichere...');const d={releases:state.releases,knownIssues:state.knownIssues,categories:state.categories,lastUpdate:new Date().toISOString()};try{const r=await fetch('/api/release_notes_manager/data',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data:JSON.stringify(d)})});if(r.ok){console.log('‚úÖ Gespeichert');setSaveStatus('‚úÖ Gespeichert!');setTimeout(()=>setSaveStatus(''),3000);return true}throw new Error(`API ${r.status}`)}catch(e){console.error('‚ùå Fehler:',e);setSaveStatus('‚ùå Fehler!');alert(`Speichern fehlgeschlagen!\n\n${e.message}`);return false}}
function setSaveStatus(t){document.getElementById('save-status').textContent=t}
function createNewRelease(){const today=new Date().toISOString().split('T')[0];const open=state.knownIssues.filter(i=>i.status!=='resolved');const inherited=open.map(i=>({...JSON.parse(JSON.stringify(i)),inheritedFrom:true}));console.log(`üìã √úbernehme ${inherited.length} offene Fehler`);state.editingRelease={id:Date.now(),version:'',name:'',date:today,features:[],changes:[],knownIssues:inherited,comments:''};showModal('release')}
async function saveRelease(){if(!state.editingRelease||!state.editingRelease.version){alert('Bitte Version eingeben!');return}state.editingRelease.knownIssues=state.editingRelease.knownIssues.map(i=>{const c={...i};delete c.inheritedFrom;return c});const isNew=!state.releases.find(r=>r.id===state.editingRelease.id);state.releases=isNew?[state.editingRelease,...state.releases]:state.releases.map(r=>r.id===state.editingRelease.id?state.editingRelease:r);state.knownIssues=state.editingRelease.knownIssues;if(await saveData()){hideModal();state.editingRelease=null;render()}}
function editRelease(id){state.editingRelease=JSON.parse(JSON.stringify(state.releases.find(r=>r.id===id)));showModal('release')}
async function deleteRelease(id){if(!confirm('Release l√∂schen?'))return;state.releases=state.releases.filter(r=>r.id!==id);await saveData();render()}
function deleteCurrentRelease(){
  if(!state.editingRelease){
    console.error('Kein Release zum L√∂schen');
    return;
  }
  if(confirm('‚ö†Ô∏è Release wirklich vollst√§ndig l√∂schen?\n\nDiese Aktion kann nicht r√ºckg√§ngig gemacht werden!')){
    const id=state.editingRelease.id;
    deleteRelease(id);
    hideModal();
  }
}
function toggleRelease(id){state.expandedReleases.has(id)?state.expandedReleases.delete(id):state.expandedReleases.add(id);render()}
function toggleDetails(rid,type,iid){const k=rid+'-'+type+'-'+iid;state.expandedDetails.has(k)?state.expandedDetails.delete(k):state.expandedDetails.add(k);renderReleases()}function loadMore(){state.displayCount+=10;renderReleases()}

function addItem(t){state.editingRelease[t].unshift({id:Date.now(),title:'',details:'',category:'general'});renderModal()}
function updateItem(t,id,f,v){state.editingRelease[t]=state.editingRelease[t].map(i=>i.id===id?{...i,[f]:v}:i)}
function removeItem(t,id){state.editingRelease[t]=state.editingRelease[t].filter(i=>i.id!==id);renderModal()}
function addKnownIssue(){state.editingRelease.knownIssues.unshift({id:Date.now(),title:'',details:'',category:'general',status:'open'});renderModal()}
function updateKnownIssue(id,f,v){state.editingRelease.knownIssues=state.editingRelease.knownIssues.map(i=>i.id===id?{...i,[f]:v}:i)}
function removeKnownIssue(id){state.editingRelease.knownIssues=state.editingRelease.knownIssues.filter(i=>i.id!==id);renderModal()}
function startResolveIssue(id){state.resolvingIssueId=id;state.resolvingSolution='';state.resolveVersion=state.editingRelease.version;renderModal()}
function confirmResolveIssue(){if(!state.resolvingIssueId)return;const issue=state.editingRelease.knownIssues.find(i=>i.id===state.resolvingIssueId);if(!issue)return;state.editingRelease.knownIssues=state.editingRelease.knownIssues.map(i=>i.id===state.resolvingIssueId?{...i,status:'resolved',resolvedInVersion:state.resolveVersion,resolution:state.resolvingSolution}:i);state.resolvingIssueId=null;state.resolvingSolution='';state.resolveVersion='';renderModal()}
function reopenIssue(id){state.editingRelease.knownIssues=state.editingRelease.knownIssues.map(i=>{if(i.id===id){const r={...i,status:'open'};delete r.resolvedInVersion;delete r.resolution;return r}return i});renderModal()}
function cancelResolveIssue(){state.resolvingIssueId=null;state.resolvingSolution='';state.resolveVersion='';renderModal()}
function showCategoriesManager(){showModal('categories')}
async function addCategory(){const l=document.getElementById('new-cat-input').value.trim();if(!l)return;const colors=['bg-gray-100 text-gray-800','bg-orange-100 text-orange-800'];state.categories.push({id:`custom_${Date.now()}`,label:l,color:colors[state.categories.length%colors.length]});await saveData();document.getElementById('new-cat-input').value='';renderModal()}
function startEditCat(id,l){state.editingCatId=id;state.editingCatLabel=l;renderModal()}
async function saveEditCat(){if(!state.editingCatLabel.trim())return;state.categories=state.categories.map(c=>c.id===state.editingCatId?{...c,label:state.editingCatLabel.trim()}:c);await saveData();state.editingCatId=null;state.editingCatLabel='';renderModal()}
function cancelEditCat(){state.editingCatId=null;state.editingCatLabel='';renderModal()}
async function deleteCategory(id){if(!confirm('Kategorie l√∂schen?'))return;state.categories=state.categories.filter(c=>c.id!==id);await saveData();renderModal()}

function showColorPicker(catId, event) {
  event.stopPropagation();
  
  // Entferne altes Popup
  const old = document.querySelector('.color-picker-popup');
  if (old) old.remove();
  
  // Erstelle Popup
  const popup = document.createElement('div');
  popup.className = 'color-picker-popup';
  popup.style.cssText = 'position: fixed; z-index: 1000; background: white; border: 1px solid #ccc; border-radius: 8px; padding: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; gap: 4px;';
  
  // Position relativ zum Klick
  const rect = event.target.getBoundingClientRect();
  popup.style.left = (rect.right + 10) + 'px';
  popup.style.top = rect.top + 'px';
  
  // F√ºge Farben hinzu
  CATEGORY_COLORS.forEach(col => {
    const box = document.createElement('div');
    box.className = col.class;
    box.style.cssText = 'width: 24px; height: 24px; border-radius: 4px; cursor: pointer;';
    box.title = col.label;
    box.onmouseover = () => box.style.outline = '2px solid #3b82f6';
    box.onmouseout = () => box.style.outline = 'none';
    box.onclick = (e) => {
      e.stopPropagation();
      selectColor(catId, col.class);
    };
    popup.appendChild(box);
  });
  
  document.body.appendChild(popup);
  
  // Schlie√üe bei Klick au√üerhalb
  setTimeout(() => {
    const closeHandler = () => {
      popup.remove();
      document.removeEventListener('click', closeHandler);
    };
    document.addEventListener('click', closeHandler);
  }, 10);
}

function selectColor(catId, colorClass) {
  state.categories = state.categories.map(c => 
    c.id === catId ? {...c, color: colorClass} : c
  );
  const popup = document.querySelector('.color-picker-popup');
  if (popup) popup.remove();
  saveData();
  renderModal();
}
function showModal(t){document.getElementById('modal').classList.add('active');document.getElementById('modal').dataset.type=t;renderModal()}
function hideModal(){document.getElementById('modal').classList.remove('active');state.editingRelease=null;state.resolvingIssueId=null}
function render(){renderCategoryFilter();renderReleases()}
function renderCategoryFilter(){const s=document.getElementById('category-filter');s.innerHTML='<option value="all">Alle Kategorien</option>'+[...state.categories].sort((a,b)=>a.label.localeCompare(b.label,'de')).map(c=>`<option value="${c.id}" ${state.filterCategory===c.id?'selected':''}>${c.label}</option>`).join('')}
function renderReleases(){const allFiltered=state.releases.filter(r=>{const ms=!state.searchTerm||JSON.stringify(r).toLowerCase().includes(state.searchTerm.toLowerCase());const mc=state.filterCategory==='all'||r.features.some(f=>f.category===state.filterCategory)||r.changes.some(c=>c.category===state.filterCategory);return ms&&mc});const f=state.searchTerm?allFiltered:allFiltered.slice(0,state.displayCount);const c=document.getElementById('releases-container');const hasMore=!state.searchTerm&&allFiltered.length>state.displayCount;c.innerHTML=f.length===0?'<div class="text-center py-12 text-gray-500"><p class="text-xl font-semibold mb-2">Keine Releases</p><p>Erstelle dein erstes Release!</p></div>':f.map(r=>renderRelease(r)).join('')+(hasMore?'<div class="text-center py-6 bg-gray-50"><button onclick="loadMore()" class="text-blue-600 hover:text-blue-800 hover:underline font-medium text-base bg-white rounded shadow-sm" style="padding: 0.5em 0.75em;">Weitere Releases laden ('+((allFiltered.length-state.displayCount))+' verbleibend)</button></div>':'')}

function renderRelease(r){ const exp=state.expandedReleases.has(r.id); const getCat=id=>state.categories.find(c=>c.id===id)||{label:id,color:'bg-gray-100 text-gray-800'}; const open=(r.knownIssues||[]).filter(i=>i.status!=='resolved'); const resolved=(r.knownIssues||[]).filter(i=>i.status==='resolved'&&i.resolvedInVersion===r.version); const title=r.name?`Version ${esc(r.version)} - ${esc(r.name)}`:`Version ${esc(r.version)}`; const isDetailExpanded=(type,id)=>state.expandedDetails.has(r.id+'-'+type+'-'+id); return`<div class="bg-white shadow rounded-lg mb-4"><div class="p-4 release-header-wrapper"><div class="release-top-row cursor-pointer" onclick="toggleRelease(${r.id})"><div><h2 class="text-xl font-bold text-blue-600 release-title">${title}</h2><p class="text-sm text-gray-600 release-date">${formatDateDE(r.date)}</p></div><div class="flex gap-2" onclick="event.stopPropagation()"><button class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300" onclick="editRelease(${r.id})" title="Release bearbeiten">‚úèÔ∏è</button></div></div><div class="release-bottom-row"><div class="release-badges">${getSummaryBadges(r)}</div></div></div>${exp?`<div class="border-t p-4">${r.features&&r.features.length>0?`<div class="mb-4"><h3 class="text-xl font-semibold mb-3">‚ú® Neue Features</h3>${r.features.map(f=>{const cat=getCat(f.category);const detKey='f-'+f.id;return`<div class="flex gap-2 mb-3 pl-3"><span class="px-2 py-1 rounded text-sm w-40 text-center ${cat.color}">${cat.label}</span><div class="flex-1"><div class="font-medium">${esc(f.title)}</div>${f.details?`<div><a href="javascript:void(0)" onclick="toggleDetails(${r.id},'f',${f.id})" class="text-xs text-blue-600 hover:underline">${isDetailExpanded('f',f.id)?'‚ñº Ausblenden':'‚ñ∂ Details anzeigen'}</a>${isDetailExpanded('f',f.id)?`<p class="text-sm text-gray-600 mt-1">${esc(f.details)}</p>`:''}</div>`:''}</div></div>`}).join('')}</div>`:''}${r.changes&&r.changes.length>0||resolved.length>0?`<div class="mb-4"><h3 class="text-xl font-semibold mb-3">üîÑ √Ñnderungen / Bugfixes</h3>${r.changes.map(c=>{const cat=getCat(c.category);return`<div class="flex gap-2 mb-3 pl-3"><span class="px-2 py-1 rounded text-sm w-40 text-center ${cat.color}">${cat.label}</span><div class="flex-1"><div class="font-medium">${esc(c.title)}</div>${c.details?`<div><a href="javascript:void(0)" onclick="toggleDetails(${r.id},'c',${c.id})" class="text-xs text-blue-600 hover:underline">${isDetailExpanded('c',c.id)?'‚ñº Ausblenden':'‚ñ∂ Details anzeigen'}</a>${isDetailExpanded('c',c.id)?`<p class="text-sm text-gray-600 mt-1">${esc(c.details)}</p>`:''}</div>`:''}</div></div>`}).join('')}${resolved.map(i=>{const cat=getCat(i.category);return`<div class="flex gap-2 mb-3 pl-3"><span class="px-2 py-1 rounded text-sm w-40 text-center ${cat.color}">${cat.label}</span><div class="flex-1"><div class="font-medium">üêõ Gel√∂st in ${esc(r.version)}: ${esc(i.title)}</div>${i.resolution?`<p class="text-sm text-gray-600">${esc(i.resolution)}</p>`:''}</div></div>`}).join('')}</div>`:''}${open.length>0?`<div class="mb-4"><h3 class="text-xl font-semibold mb-3">‚ö†Ô∏è Bekannte Fehler</h3>${open.map(i=>{const cat=getCat(i.category);return`<div class="border border-yellow-200 rounded mb-2 bg-yellow-50"><div class="flex gap-2 items-stretch p-3"><span class="px-2 py-1 rounded text-sm w-40 text-center ${cat.color}">${cat.label}</span><div class="flex-1"><div class="font-medium">${esc(i.title)}</div>${i.details?`<div><a href="javascript:void(0)" onclick="toggleDetails(${r.id},'i',${i.id})" class="text-xs text-blue-600 hover:underline">${isDetailExpanded('i',i.id)?'‚ñº Ausblenden':'‚ñ∂ Details anzeigen'}</a>${isDetailExpanded('i',i.id)?`<p class="text-sm text-gray-600 mt-1">${esc(i.details)}</p>`:''}</div>`:''}</div></div></div>`}).join('')}</div>`:''}${r.comments?`<div class="text-sm text-gray-600 bg-gray-50 p-3 rounded">${esc(r.comments)}</div>`:''}</div>`:''}</div>` }

function renderModal(){const m=document.getElementById('modal');const c=m.querySelector('.modal-content');const t=m.dataset.type;if(t==='categories'){c.innerHTML=`<div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Kategorien verwalten</h2><button class="px-4 py-2 bg-gray-200 rounded" onclick="hideModal()">Schlie√üen</button></div><div class="mb-6"><label class="block text-sm font-medium mb-2">Neue Kategorie</label><div class="flex gap-2"><input type="text" id="new-cat-input" placeholder="Name..." class="flex-1 px-3 py-2 rounded" onkeypress="if(event.key==='Enter')addCategory()"/><button class="px-4 py-2 bg-blue-600 text-white rounded" onclick="addCategory()">+ Hinzuf√ºgen</button></div></div>${[...state.categories].sort((a,b)=>a.label.localeCompare(b.label,'de')).map(c=>state.editingCatId===c.id?`<div class="flex gap-2 items-center p-3 border rounded mb-2"><input type="text" value="${esc(state.editingCatLabel)}" oninput="state.editingCatLabel=this.value" class="flex-1 px-2 py-1 rounded" onkeypress="if(event.key==='Enter')saveEditCat()"/><button class="px-3 py-1 bg-green-600 text-white rounded" onclick="saveEditCat()">Speichern</button><button class="px-3 py-1 bg-gray-200 rounded" onclick="cancelEditCat()">Abbrechen</button></div>`:`<div class="flex justify-between items-center p-3 border rounded mb-2"><span class="px-3 py-1 rounded text-sm ${c.color} cursor-pointer hover:opacity-80" onclick="showColorPicker('${c.id}', event)" title="Klicken um Farbe zu √§ndern">${c.label}</span><div class="flex gap-2"><button class="px-3 py-1 bg-gray-200 rounded" onclick="startEditCat('${c.id}','${esc(c.label)}')">Name √§ndern</button><button class="px-3 py-1 bg-red-100 text-red-600 rounded" onclick="deleteCategory('${c.id}')">L√∂schen</button></div></div>`).join('')}`}else if(t==='release'&&state.editingRelease){const r=state.editingRelease;const isNew=!state.releases.find(rel=>rel.id===r.id);const inherited=r.knownIssues.filter(i=>i.inheritedFrom).length;c.innerHTML=`<div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">${isNew?'Neues Release':'Release bearbeiten'}</h2><div class="flex gap-2"><button class="px-4 py-2 bg-gray-200 rounded" onclick="hideModal()">Abbrechen</button><button class="px-4 py-2 bg-blue-600 text-white rounded" onclick="saveRelease()">Speichern</button></div></div>${isNew&&inherited>0?`<div class="bg-yellow-50 border border-yellow-200 rounded p-3 mb-4"><p class="text-sm"><strong>‚ÑπÔ∏è ${inherited} offene${inherited===1?'r Fehler wurde':' Fehler wurden'} automatisch √ºbernommen</strong></p></div>`:''}<div class="grid grid-cols-2 gap-4 mb-4"><div><label class="block text-sm font-medium mb-2">Version *</label><input type="text" value="${esc(r.version)}" oninput="state.editingRelease.version=this.value" class="w-full px-3 py-2 rounded" placeholder="z.B. 2025.1.1"/></div><div><label class="block text-sm font-medium mb-2">Name (optional)</label><input type="text" value="${esc(r.name||'')}" oninput="state.editingRelease.name=this.value" class="w-full px-3 py-2 rounded" placeholder="z.B. Stable Release"/></div></div><div class="mb-4"><label class="block text-sm font-medium mb-2">Datum</label><input type="date" value="${r.date}" oninput="state.editingRelease.date=this.value" class="w-full px-3 py-2 rounded"/></div><div class="border-t pt-4 mb-4"><div class="flex justify-between mb-3"><h3 class="text-xl font-semibold">‚ú® Neue Features</h3><button class="px-3 py-1 bg-green-600 text-white rounded" onclick="addItem('features')">+ Hinzuf√ºgen</button></div>${r.features.map(f=>`<div class="border rounded p-3 mb-3 bg-gray-50"><div class="flex gap-2 mb-2"><input type="text" value="${esc(f.title)}" oninput="updateItem('features',${f.id},'title',this.value)" placeholder="Titel..." class="flex-1 px-2 py-1 rounded"/><select onchange="updateItem('features',${f.id},'category',this.value)" class="px-2 py-1 rounded">${[...state.categories].sort((a,b)=>a.label.localeCompare(b.label,'de')).map(c=>`<option value="${c.id}" ${f.category===c.id?'selected':''}>${c.label}</option>`).join('')}</select><button class="px-2 py-1 bg-red-100 text-red-600 rounded" onclick="removeItem('features',${f.id})">√ó</button></div><textarea oninput="updateItem('features',${f.id},'details',this.value)" placeholder="Details..." class="w-full px-2 py-1 rounded" rows="3">${esc(f.details||'')}</textarea></div>`).join('')}${r.features.length===0?'<p class="text-gray-500 italic">Keine Features</p>':''}</div><div class="border-t pt-4 mb-4"><div class="flex justify-between mb-3"><h3 class="text-xl font-semibold">üîÑ √Ñnderungen / Bugfixes</h3><button class="px-3 py-1 bg-green-600 text-white rounded" onclick="addItem('changes')">+ Hinzuf√ºgen</button></div>${r.changes.map(c=>`<div class="border rounded p-3 mb-3 bg-gray-50"><div class="flex gap-2 mb-2"><input type="text" value="${esc(c.title)}" oninput="updateItem('changes',${c.id},'title',this.value)" placeholder="Titel..." class="flex-1 px-2 py-1 rounded"/><select onchange="updateItem('changes',${c.id},'category',this.value)" class="px-2 py-1 rounded">${[...state.categories].sort((a,b)=>a.label.localeCompare(b.label,'de')).map(cat=>`<option value="${cat.id}" ${c.category===cat.id?'selected':''}>${cat.label}</option>`).join('')}</select><button class="px-2 py-1 bg-red-100 text-red-600 rounded" onclick="removeItem('changes',${c.id})">√ó</button></div><textarea oninput="updateItem('changes',${c.id},'details',this.value)" placeholder="Details..." class="w-full px-2 py-1 rounded" rows="3">${esc(c.details||'')}</textarea></div>`).join('')}${r.changes.length===0?'<p class="text-gray-500 italic">Keine √Ñnderungen</p>':''}</div><div class="border-t pt-4 mb-4"><div class="flex justify-between mb-3"><h3 class="text-xl font-semibold">‚ö†Ô∏è Bekannte Fehler</h3><button class="px-3 py-1 bg-yellow-600 text-white rounded" onclick="addKnownIssue()">+ Hinzuf√ºgen</button></div>${r.knownIssues.map(i=>state.resolvingIssueId===i.id?`<div class="space-y-3"><div class="bg-green-50 border border-green-200 rounded p-3"><h4 class="font-semibold text-green-800 mb-2">‚úì Fehler als gel√∂st markieren</h4><p class="text-sm text-green-700 mb-3">Fehler: <strong>${esc(i.title)}</strong></p><div class="space-y-2"><label class="block text-sm font-medium text-gray-700">In Version gel√∂st (optional):</label><input type="text" value="${esc(state.resolveVersion)}" oninput="state.resolveVersion=this.value" placeholder="${r.version}" class="w-full px-3 py-2 border rounded"/><label class="block text-sm font-medium text-gray-700 mt-3">Beschreibung der L√∂sung (optional):</label><textarea oninput="state.resolvingSolution=this.value" placeholder="Beschreibe wie der Fehler gel√∂st wurde..." class="w-full px-3 py-2 border rounded" rows="3">${esc(state.resolvingSolution)}</textarea></div><div class="flex gap-2 mt-3"><button class="px-4 py-2 bg-green-600 text-white rounded" onclick="confirmResolveIssue()">${state.resolvingSolution.trim()?'L√∂sung dokumentieren':'Als gel√∂st markieren'}</button><button class="px-4 py-2 bg-gray-200 rounded" onclick="cancelResolveIssue()">Abbrechen</button></div></div></div>`:i.status==='resolved'?`<div class="border border-green-200 rounded p-3 mb-3 bg-green-50"><div class="flex gap-2 mb-2 items-start"><span class="px-2 py-1 rounded text-sm bg-green-100 text-green-800">‚úì Gel√∂st in ${esc(i.resolvedInVersion||'?')}</span><div class="flex-1"><div class="font-medium text-gray-600 line-through">${esc(i.title)}</div>${i.resolution?`<p class="text-sm text-gray-600">${esc(i.resolution)}</p>`:''}</div><button class="px-2 py-1 bg-yellow-100 text-yellow-600 rounded" onclick="reopenIssue(${i.id})" title="Fehler wieder √∂ffnen">üîì Wieder √∂ffnen</button></div></div>`:`<div class="border border-yellow-200 rounded p-3 mb-3 bg-yellow-50"><div class="flex gap-2 mb-2"><input type="text" value="${esc(i.title)}" oninput="updateKnownIssue(${i.id},'title',this.value)" placeholder="Fehler..." class="flex-1 px-2 py-1 rounded"/><select onchange="updateKnownIssue(${i.id},'category',this.value)" class="px-2 py-1 rounded">${[...state.categories].sort((a,b)=>a.label.localeCompare(b.label,'de')).map(cat=>`<option value="${cat.id}" ${(i.category||'general')===cat.id?'selected':''}>${cat.label}</option>`).join('')}</select><button class="px-2 py-1 bg-green-100 text-green-600 rounded" onclick="startResolveIssue(${i.id})" title="Als gel√∂st markieren">‚úì Gel√∂st</button><button class="px-2 py-1 bg-red-100 text-red-600 rounded" onclick="removeKnownIssue(${i.id})">√ó</button></div><textarea oninput="updateKnownIssue(${i.id},'details',this.value)" placeholder="Details..." class="w-full px-2 py-1 rounded" rows="2">${esc(i.details||'')}</textarea></div>`).join('')}${r.knownIssues.length===0?'<p class="text-gray-500 italic">Keine bekannten Fehler</p>':''}</div><div class="border-t pt-4"><label class="block text-sm font-medium mb-2">Kommentare (optional)</label><textarea oninput="state.editingRelease.comments=this.value" class="w-full px-3 py-2 rounded" rows="3" placeholder="Zus√§tzliche Informationen...">${esc(r.comments||'')}</textarea></div><div class="border-t pt-4 mt-4 flex justify-end"><button class="px-4 py-2 bg-red-600 text-white rounded font-medium hover:bg-red-700" onclick="deleteCurrentRelease()">Release vollst√§ndig l√∂schen</button></div>`}}
function esc(t){const d=document.createElement('div');d.textContent=t||'';return d.innerHTML}
function getSummaryBadges(r) {
  const featCount = r.features?.length || 0;
  const changeCount = r.changes?.length || 0;
  const issueCount = (r.knownIssues || []).filter(i => i.status !== 'resolved').length;
  
  const badges = [];
  
  // Badge 1: Features (oder leer)
  if (featCount > 0) {
    const label = featCount === 1 ? 'Feature' : 'Features';
    badges.push('<span class="px-2 py-1 rounded text-xs bg-green-600 text-white badge-features">' + featCount + ' ' + label + '</span>');
  } else {
    badges.push('<span></span>');
  }
  
  // Badge 2: √Ñnderungen (oder leer)
  if (changeCount > 0) {
    const label = changeCount === 1 ? '√Ñnderung' : '√Ñnderungen';
    badges.push('<span class="px-2 py-1 rounded text-xs bg-blue-500 text-white badge-changes">' + changeCount + ' ' + label + '</span>');
  } else {
    badges.push('<span></span>');
  }
  
  // Badge 3: Fehler (oder leer)
  if (issueCount > 0) {
    const label = issueCount === 1 ? 'Fehler' : 'Fehler';
    badges.push('<span class="px-2 py-1 rounded text-xs bg-yellow-500 text-black badge-issues">' + issueCount + ' ' + label + '</span>');
  } else {
    badges.push('<span></span>');
  }
  
  return badges.join('');
}
document.getElementById('search-input').addEventListener('input',e=>{state.searchTerm=e.target.value;render()});
document.getElementById('category-filter').addEventListener('change',e=>{state.filterCategory=e.target.value;render()});
console.log('üöÄ Home Assistant Release Notes Manager v0.5.0-CORRECTED startet...');
loadData();
  </script>

  <!-- Versions-Anzeige -->
  <div style="position: fixed; bottom: 10px; left: 10px; font-size: 11px; color: #9ca3af; font-family: monospace; z-index: 1000;">
    Backend: v0.5.0 | Frontend: v0.5.0
  </div>
</body>
</html>
